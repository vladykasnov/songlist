<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Таблица</title>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px 0; font-size: 20px; }
    .hint { margin: 0 0 18px 0; color: #555; font-size: 14px; }
    table.dataTable thead th, table.dataTable tfoot th { white-space: nowrap; }
    tfoot th { padding: 8px 10px; }
    tfoot input { width: 100%; box-sizing: border-box; padding: 6px 8px; }
    .toolbar { display: flex; gap: 12px; align-items: center; margin: 0 0 12px 0; }
    .toolbar label { font-size: 14px; display: inline-flex; gap: 8px; align-items: center; }
  </style>
</head>

<body>
  <h1>Список песен Kosmos Lada / Сонглист</h1>

  <table id="tbl" class="display nowrap" style="width:100%">
    <thead><tr id="thead-row"></tr></thead>
    <tfoot><tr id="tfoot-row"></tr></tfoot>
    <tbody></tbody>
  </table>

  <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQT--4KZJ3KbXm8HRJviqgQ5lx9FZKeJ_u9UFX3A3uNhFNa1-ELmJnHcFGqC66Y4pY8R8GZbVOeKn-i/pub?gid=1948772342&single=true&output=csv";

    // индексы столбцов (0-based)
    const ID_COL_INDEX = 0;       // ID (внутренний)
    const ACTIVE_COL_INDEX = 3;   // "Активна?"

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function loadCsv() {
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Не удалось загрузить CSV");
      return await res.text();
    }

    function normalizeBool(v) {
      const s = String(v ?? "").trim().toUpperCase();
      return s === "TRUE" || s === "FALSE" ? s : s;
    }

    function buildHeaderAndFooter(headers) {
      const thead = document.getElementById("thead-row");
      const tfoot = document.getElementById("tfoot-row");
      thead.innerHTML = "";
      tfoot.innerHTML = "";

      headers.forEach((h, idx) => {
        const title = h || ("Колонка " + (idx + 1));

        // THEAD
        const th1 = document.createElement("th");
        th1.textContent = title;
        thead.appendChild(th1);

        // TFOOT: фильтры только для видимых столбцов
        const th2 = document.createElement("th");
        if (idx !== ID_COL_INDEX && idx !== ACTIVE_COL_INDEX) {
          th2.innerHTML = `<input type="text" placeholder="Фильтр..." />`;
        }
        tfoot.appendChild(th2);
      });
    }

    async function init() {
      const csvText = await loadCsv();

      const parsed = Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true
      });

      const headers = parsed.meta.fields ?? [];
      const rows = parsed.data
        .filter(r => Object.values(r).some(v => String(v ?? "").trim() !== ""))
        .map(obj => headers.map(h => obj[h] ?? ""));

      if (!headers.length) {
        throw new Error("CSV без заголовков");
      }

      // нормализуем "Активна?"
      rows.forEach(r => {
        r[ACTIVE_COL_INDEX] = normalizeBool(r[ACTIVE_COL_INDEX]);
      });

      buildHeaderAndFooter(headers);

      const table = $("#tbl").DataTable({
        data: rows.map(r => r.map(escapeHtml)),
        columns: headers.map(h => ({ title: h })),
        responsive: true,
        pageLength: 25,
        order: [],
        deferRender: true,

        columnDefs: [
          {
            targets: ID_COL_INDEX,
            visible: false,
            searchable: false   // полностью исключаем ID
          },
          {
            targets: ACTIVE_COL_INDEX,
            visible: false,
            searchable: true    // нужен для фильтра TRUE/FALSE
          }
        ],

        language: {
          search: "Поиск:",
          lengthMenu: "Показывать _MENU_ строк",
          info: "Показано _START_–_END_ из _TOTAL_",
          infoEmpty: "Нет данных",
          zeroRecords: "Ничего не найдено",
          paginate: {
            first: "Первая",
            last: "Последняя",
            next: "Следующая",
            previous: "Предыдущая"
          }
        }
      });

      // фильтр по умолчанию: только TRUE
      table.column(ACTIVE_COL_INDEX)
        .search("^TRUE$", true, false)
        .draw();

      // фильтры по столбцам (кроме ID и Активна?)
      table.columns().every(function (idx) {
        if (idx === ID_COL_INDEX || idx === ACTIVE_COL_INDEX) return;
        const that = this;
        $("input", this.footer()).on("keyup change clear", function () {
          if (that.search() !== this.value) {
            that.search(this.value).draw();
          }
        });
      });

      // чекбокс "показывать неактивные"
      document.getElementById("showInactive")
        .addEventListener("change", e => {
          if (e.target.checked) {
            table.column(ACTIVE_COL_INDEX).search("").draw();
          } else {
            table.column(ACTIVE_COL_INDEX)
              .search("^TRUE$", true, false)
              .draw();
          }
        });
    }

    init().catch(err => {
      document.body.insertAdjacentHTML(
        "beforeend",
        `<p style="color:#b00020"><b>Ошибка:</b> ${escapeHtml(err.message)}</p>`
      );
      console.error(err);
    });
  </script>
</body>
</html>
