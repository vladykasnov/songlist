<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Сонглист</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 10px 0; font-size: 20px; }
    #meta { margin: 0 0 14px 0; font-size: 12px; color: #555; }
    table.dataTable thead th { white-space: nowrap; font-weight: 700; }

    .dt-sub { font-size: 12px; color: #666; margin-top: 2px; line-height: 1.2; }

    @media (max-width: 700px) {
      body { margin: 14px; }
      h1 { font-size: 18px; }
    }
  </style>
</head>

<body>
  <h1>Список песен Kosmos Lada / Сонглист</h1>
  <p id="meta"></p>

  <table id="tbl" class="display" style="width:100%">
    <thead><tr id="thead-row"></tr></thead>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQT--4KZJ3KbXm8HRJviqgQ5lx9FZKeJ_u9UFX3A3uNhFNa1-ELmJnHcFGqC66Y4pY8R8GZbVOeKn-i/pub?gid=1948772342&single=true&output=csv";

    const isNarrow = window.matchMedia("(max-width: 700px)").matches;

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeBool(v) {
      const s = String(v ?? "").trim().toUpperCase();
      return (s === "TRUE" || s === "FALSE") ? s : s;
    }

    async function loadCsvText() {
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Не удалось загрузить CSV");
      return await res.text();
    }

    function findCol(headers, predicate) {
      const idx = headers.findIndex(h => predicate(String(h ?? "").trim().toLowerCase()));
      return idx >= 0 ? idx : -1;
    }

    function buildThead(labels) {
      const theadRow = document.getElementById("thead-row");
      theadRow.innerHTML = "";
      labels.forEach(l => {
        const th = document.createElement("th");
        th.textContent = l;
        theadRow.appendChild(th);
      });
    }

    async function init() {
      const csvText = await loadCsvText();

      // Парсим как матрицу: 1-я строка мета, 2-я заголовки
      const parsed = Papa.parse(csvText, { header: false, skipEmptyLines: true });
      const matrix = parsed.data ?? [];
      if (matrix.length < 2) throw new Error("CSV должен содержать минимум 2 строки (мета + заголовки)");

      // 1-я строка: мета
      const metaText = matrix[0].filter(x => String(x ?? "").trim() !== "").join("  ");
      document.getElementById("meta").textContent = metaText;

      // 2-я строка: заголовки
      const headers = matrix[1].map(h => String(h ?? "").trim());

      // Данные
      const dataRows = matrix.slice(2).filter(r => r.some(v => String(v ?? "").trim() !== ""));

      // Индексы нужных колонок
      const titleCol  = findCol(headers, h => h.includes("назван") || h.includes("песня") || h === "название");
      const artistCol = findCol(headers, h => h.includes("артист"));
      const activeCol = findCol(headers, h => h.includes("актив"));

      if (titleCol === -1) throw new Error("Не найдена колонка 'Название'");
      if (artistCol === -1) throw new Error("Не найдена колонка 'Артист'");
      if (activeCol === -1) throw new Error("Не найдена колонка 'Активна?'");

      // Нормализуем активность и фильтруем только TRUE
      dataRows.forEach(r => { r[activeCol] = normalizeBool(r[activeCol]); });
      const activeRows = dataRows.filter(r => String(r[activeCol]).trim().toUpperCase() === "TRUE");

      // В DataTables всегда храним [Название, Артист] — сырые строки (БЕЗ escape)
      const dtRows = activeRows.map(r => [r[titleCol] ?? "", r[artistCol] ?? ""]);

      const titleHeader = headers[titleCol] || "Название";
      const artistHeader = headers[artistCol] || "Артист";

      // THEAD должен иметь 2 колонки всегда (даже если 2-я скрыта на мобиле)
      buildThead([titleHeader, artistHeader]);

      $("#tbl").DataTable({
        data: dtRows, // <-- важно: сырые данные
        columns: [
          { title: titleHeader },
          { title: artistHeader }
        ],
        responsive: false,
        pageLength: 25,
        order: [],
        deferRender: true,
        autoWidth: false,
        language: {
          search: "Поиск:",
          lengthMenu: "Показывать _MENU_ строк",
          info: "Показано _START_–_END_ из _TOTAL_",
          infoEmpty: "Нет данных",
          zeroRecords: "Ничего не найдено",
          paginate: { first: "Первая", last: "Последняя", next: "Следующая", previous: "Предыдущая" }
        },
        columnDefs: [
          // На мобиле: скрываем "Артист", но оставляем searchable
          ...(isNarrow ? [{
            targets: 1,
            visible: false,
            searchable: true
          }] : []),

          // На мобиле: в первой колонке показываем Название + Артист второй строкой
          ...(isNarrow ? [{
            targets: 0,
            render: function (data, type, row) {
              const title = String(data ?? "");
              const artist = String(row[1] ?? "");
              if (type === "display") {
                const titleHtml = escapeHtml(title);
                const artistHtml = artist.trim() ? `<div class="dt-sub">${escapeHtml(artist)}</div>` : "";
                return `<div>${titleHtml}</div>${artistHtml}`;
              }
              // для сортировки/поиска используем сырое значение
              return title;
            }
          }] : []),

          // На десктопе: безопасный вывод обоих столбцов (escape только на display)
          ...(!isNarrow ? [{
            targets: [0, 1],
            render: function (data, type) {
              if (type === "display") return escapeHtml(data);
              return data;
            }
          }] : [])
        ]
      });
    }

    init().catch(err => {
      document.body.insertAdjacentHTML(
        "beforeend",
        `<p style="color:#b00020"><b>Ошибка:</b> ${escapeHtml(err.message)}</p>`
      );
      console.error(err);
    });
  </script>
</body>
</html>
