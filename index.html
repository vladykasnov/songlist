<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Таблица</title>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px 0; font-size: 20px; }
    .hint { margin: 0 0 18px 0; color: #555; font-size: 14px; }
    table.dataTable thead th, table.dataTable tfoot th { white-space: nowrap; }
    tfoot th { padding: 8px 10px; }
    tfoot input { width: 100%; box-sizing: border-box; padding: 6px 8px; }
    .toolbar { display: flex; gap: 12px; align-items: center; margin: 0 0 12px 0; flex-wrap: wrap; }
    .toolbar label { font-size: 14px; color: #333; display: inline-flex; gap: 8px; align-items: center; }
  </style>
</head>

<body>
  <h1>Таблица из Google Sheets</h1>
  <p class="hint">
    Поиск — вверху справа. Сортировка — клик по заголовку. Фильтр по столбцу — поля внизу.
    По умолчанию показаны только строки, где «Активна?» = TRUE (столбец скрыт).
  </p>

  <div class="toolbar">
    <label>
      <input type="checkbox" id="showInactive">
      Показывать неактивные (FALSE)
    </label>
  </div>

  <table id="tbl" class="display nowrap" style="width:100%">
    <thead><tr id="thead-row"></tr></thead>
    <tfoot><tr id="tfoot-row"></tr></tfoot>
    <tbody></tbody>
  </table>

  <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Ваш CSV
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQT--4KZJ3KbXm8HRJviqgQ5lx9FZKeJ_u9UFX3A3uNhFNa1-ELmJnHcFGqC66Y4pY8R8GZbVOeKn-i/pub?gid=1948772342&single=true&output=csv";

    // 4-й столбец -> индекс 3
    const ACTIVE_COL_INDEX = 3; // "Активна?"

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function loadCsv() {
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Не удалось загрузить CSV: " + res.status);
      return await res.text();
    }

    function buildHeaderAndFooter(headers) {
      const thead = document.getElementById("thead-row");
      const tfoot = document.getElementById("tfoot-row");

      thead.innerHTML = "";
      tfoot.innerHTML = "";

      headers.forEach((h, idx) => {
        const title = h || ("Колонка " + (idx + 1));

        // THEAD
        const th1 = document.createElement("th");
        th1.textContent = title;
        thead.appendChild(th1);

        // TFOOT: фильтры по столбцам (кроме скрытого)
        const th2 = document.createElement("th");
        if (idx !== ACTIVE_COL_INDEX) {
          th2.innerHTML = `<input type="text" placeholder="Фильтр..." aria-label="Фильтр по столбцу ${title}">`;
        } else {
          th2.innerHTML = ""; // скрытый столбец — без фильтра
        }
        tfoot.appendChild(th2);
      });
    }

    function toDataTablesData(parsed) {
      const headers = parsed.meta.fields ?? [];
      const rows = parsed.data
        .filter(r => Object.values(r).some(v => (v ?? "").toString().trim() !== "")) // убрать пустые строки
        .map(obj => headers.map(h => obj[h] ?? ""));
      return { headers, rows };
    }

    function normalizeBool(v) {
      // приводим к "TRUE"/"FALSE" чтобы фильтр был надежным даже если в данных разный регистр/пробелы
      const s = String(v ?? "").trim().toUpperCase();
      if (s === "TRUE" || s === "FALSE") return s;
      return s; // оставляем как есть на всякий случай
    }

    async function init() {
      const csvText = await loadCsv();

      const parsed = Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true
      });

      if (parsed.errors?.length) {
        console.warn("PapaParse errors:", parsed.errors);
      }

      const { headers, rows } = toDataTablesData(parsed);

      if (!headers.length) {
        throw new Error("Не удалось определить заголовки CSV. Убедитесь, что первая строка — заголовки столбцов.");
      }
      if (headers.length <= ACTIVE_COL_INDEX) {
        throw new Error("В CSV меньше 4-х столбцов. Проверьте структуру таблицы и индекс ACTIVE_COL_INDEX.");
      }

      // Нормализуем значения в "Активна?" для надежного фильтра
      rows.forEach(r => { r[ACTIVE_COL_INDEX] = normalizeBool(r[ACTIVE_COL_INDEX]); });

      buildHeaderAndFooter(headers);

      const table = $("#tbl").DataTable({
        data: rows.map(r => r.map(escapeHtml)),
        columns: headers.map(h => ({ title: h })),
        responsive: true,
        pageLength: 25,
        lengthMenu: [10, 25, 50, 100],
        order: [],
        deferRender: true,

        columnDefs: [
          {
            targets: ACTIVE_COL_INDEX,
            visible: false,   // скрываем "Активна?"
            searchable: true  // но оставляем возможность фильтровать программно
          }
        ],

        language: {
          search: "Поиск:",
          lengthMenu: "Показывать _MENU_ строк",
          info: "Показано _START_–_END_ из _TOTAL_",
          infoEmpty: "Нет данных",
          zeroRecords: "Ничего не найдено",
          paginate: { first: "Первая", last: "Последняя", next: "Следующая", previous: "Предыдущая" }
        }
      });

      // Фильтр по умолчанию: показываем только TRUE
      table.column(ACTIVE_COL_INDEX).search("^TRUE$", true, false).draw();

      // Колоночные фильтры (tfoot inputs) — пропускаем скрытый столбец
      table.columns().every(function (idx) {
        if (idx === ACTIVE_COL_INDEX) return;
        const that = this;
        $("input", this.footer()).on("keyup change clear", function () {
          if (that.search() !== this.value) {
            that.search(this.value).draw();
          }
        });
      });

      // Чекбокс "показывать неактивные"
      const chk = document.getElementById("showInactive");
      chk.addEventListener("change", () => {
        if (chk.checked) {
          // показать все (TRUE и FALSE)
          table.column(ACTIVE_COL_INDEX).search("", false, false).draw();
        } else {
          // только TRUE
          table.column(ACTIVE_COL_INDEX).search("^TRUE$", true, false).draw();
        }
      });
    }

    init().catch(err => {
      document.body.insertAdjacentHTML(
        "beforeend",
        `<p style="color:#b00020"><b>Ошибка:</b> ${escapeHtml(err.message)}</p>`
      );
      console.error(err);
    });
  </script>
</body>
</html>
